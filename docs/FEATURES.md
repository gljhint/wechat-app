# 功能说明文档

本文档详细介绍微信教会管理系统的所有功能模块、使用方法和操作指南。

## 📋 目录

- [用户角色与权限](#用户角色与权限)
- [端到端加密聊天](#端到端加密聊天)
- [学习打卡系统](#学习打卡系统)
- [在线直播会议](#在线直播会议)
- [文档管理](#文档管理)
- [颂主圣诗](#颂主圣诗)
- [后台管理](#后台管理)

---

## 用户角色与权限

系统采用基于角色的访问控制（RBAC），提供微信端和后台管理端分离的权限体系。

### 内置角色

| 角色代码 | 显示名称 | 权限级别 | 适用人群 |
|---------|---------|---------|---------|
| `admin` | 管理员 | 最高权限 | 系统管理员、牧师 |
| `ministry` | 服侍组 | 高级权限 | 事工负责人、同工 |
| `member` | 成员组 | 标准权限 | 正式成员 |
| `pre_member` | 准成员组 | 受限权限 | 预备成员、慕道友 |
| `seeker` | 慕道组 | 基础权限 | 初次接触者 |
| `external` | 外教会 | 基础权限 | 外教会访客 |

### 微信端权限列表

| 权限代码 | 权限名称 | 描述 |
|---------|---------|------|
| `chat.view` | 查看聊天 | 访问聊天功能 |
| `chat.private` | 私聊权限 | 发起私聊 |
| `chat.group` | 群聊权限 | 创建和加入群聊 |
| `chat.group.create` | 创建群组 | 创建新的聊天群组 |
| `live.view` | 查看直播 | 观看直播 |
| `live.create` | 创建直播 | 发起直播（需额外配置） |
| `document.view` | 查看文档 | 浏览文档库 |
| `document.download` | 下载文档 | 下载文档文件 |
| `document.upload` | 上传文档 | 上传新文档 |
| `checkin.daily` | 每日打卡 | 进行学习打卡 |
| `checkin.view.others` | 查看他人打卡 | 查看其他成员打卡情况 |
| `songs.view` | 查看圣诗 | 访问圣诗库 |

### 后台管理端权限

| 权限代码 | 权限名称 | 描述 |
|---------|---------|------|
| `admin.dashboard` | 访问仪表盘 | 查看后台首页 |
| `admin.users.view` | 查看用户 | 浏览用户列表 |
| `admin.users.edit` | 编辑用户 | 修改用户信息 |
| `admin.users.delete` | 删除用户 | 删除用户账号 |
| `admin.live.manage` | 管理直播 | 创建、编辑、删除直播 |
| `admin.documents.manage` | 管理文档 | 文档的增删改查 |
| `admin.checkins.view` | 查看打卡统计 | 查看所有打卡数据 |
| `admin.messages.stats` | 查看消息统计 | 查看聊天统计数据（无法查看内容） |
| `admin.roles.manage` | 管理角色权限 | 配置角色和权限（超级管理员） |

### 角色分配

**微信端用户角色分配：**

1. 登录后台管理系统
2. 进入「用户管理」
3. 找到目标用户，点击「编辑」
4. 在「角色」下拉菜单中选择合适的角色
5. 点击「保存」

**后台管理员角色分配：**

1. 以超级管理员身份登录
2. 进入「管理员管理」
3. 创建或编辑管理员账号
4. 勾选需要授予的权限
5. 保存更改

---

## 端到端加密聊天

系统最核心的功能，提供完全隐私保护的即时通讯。

### 加密原理

- **加密算法**：AES-256-CBC
- **密钥派生**：从 `APP_KEY` 使用 HMAC-SHA256 派生对话密钥
- **加密范围**：消息内容、媒体文件URL、文件名
- **隐私保护**：管理员无法查看聊天内容，仅能统计消息数量

详细原理请参考 [端到端加密技术文档](../CHAT_ENCRYPTION_README.md)。

### 私聊功能

#### 发起私聊

1. 进入「聊天」页面
2. 点击右上角「+」按钮
3. 选择「发起私聊」
4. 从用户列表选择聊天对象
5. 开始聊天

#### 支持的消息类型

| 类型 | 代码 | 支持格式 |
|------|------|----------|
| 文本消息 | `TYPE_TEXT` | 纯文本、表情符号 |
| 图片消息 | `TYPE_IMAGE` | JPG, PNG, GIF, WEBP |
| 视频消息 | `TYPE_VIDEO` | MP4, MOV, AVI |
| 文件消息 | `TYPE_FILE` | PDF, DOC, DOCX, XLS, XLSX, ZIP, RAR |


### 群聊功能

#### 创建群组

1. 进入「聊天」页面
2. 点击右上角「+」按钮
3. 选择「创建群聊」
4. 选择群成员（至少 2 人）
5. 输入群名称
6. 点击「创建」

#### 群组管理（群主权限）

**邀请成员：**
1. 进入群聊
2. 点击右上角「···」
3. 选择「添加成员」
4. 从用户列表选择
5. 确认邀请

**移除成员：**
1. 进入群聊
2. 点击右上角「···」
3. 选择「群成员」
4. 找到目标成员，点击「移除」


**解散群聊：**
1. 进入群聊
2. 点击右上角「···」
3. 下拉到底部，点击「解散群聊」
4. 确认操作

#### 群头像

系统根据群成员头像自动生成九宫格群头像，支持 4-9 人群组。

### 自动清理机制

为了节省存储空间，系统支持自动清理过期聊天记录。

**配置方法：**

在 `.env` 文件中设置：

```env
# 保留天数（0 = 永久保存）
CHAT_RETENTION_DAYS=90

# 启用自动清理
CHAT_AUTO_CLEANUP_ENABLED=true

# 批量删除数量
CHAT_CLEANUP_BATCH_SIZE=1000
```

**手动清理：**

```bash
php artisan chat:cleanup-messages
```

---

## 学习打卡系统

帮助成员养成每日读经灵修习惯的工具。

### 每日任务

#### 任务内容

每日任务包含两部分：

1. **读经内容**：指定的圣经章节
2. **灵修内容**：灵修文章或反思问题

#### 任务发布（管理员）

1. 登录后台管理
2. 进入「学习任务管理」
3. 点击「创建任务」
4. 填写任务信息：
   - 任务日期
   - 读经内容（如：约翰福音 3:16-21）
   - 灵修内容
5. 点击「保存」


### 用户打卡

#### 打卡流程

1. 进入「打卡」页面
2. 查看当日任务
3. 完成读经和灵修
4. 点击「打卡」
6. 提交打卡

#### 补打卡

忘记打卡？可以补打过去 7 天的卡：

1. 进入「打卡历史」
2. 找到未打卡的日期
3. 点击「补打卡」
4. 填写内容并提交

### 打卡统计

#### 个人统计

在「个人中心」-「我的打卡」查看：

- 连续打卡天数
- 本月打卡次数
- 累计打卡天数
- 打卡日历

#### 管理员统计

后台管理可查看：

- 整体打卡率
- 各角色打卡情况
- 成员打卡排行

---

## 在线直播会议

基于 Cloudflare RealtimeKit 的高质量音视频通话功能。

### 直播类型

系统支持两种直播模式：

1. **固定直播室**：预先创建的长期直播间（如：主日崇拜、祷告会）

### 创建直播（管理员）

#### 后台创建

1. 登录后台管理
2. 进入「直播管理」
3. 点击「创建直播」
4. 填写直播信息：
   - 直播标题
   - 直播描述
   - 可见角色（选择哪些角色可以看到此直播）
5. 点击「保存」


### 主播权限配置

默认情况下，只有管理员进直播间都有主播权限（可踢人、静音）



### 观看直播

1. 进入「发现」页面
2. 在「直播列表」中找到正在进行的直播
3. 点击进入直播间
4. 允许浏览器访问麦克风和摄像头（如需互动）
5. 开始观看

### 直播互动

**观众互动功能：**

- 实时评论

**主播控制功能：**

- 开启/关闭摄像头
- 静音/取消静音
- 共享屏幕
- 管理观众（禁言、踢出）
- 结束直播


---

## 文档管理

提供文档上传、下载、分类和权限控制功能。

### 文档分类

通过标签系统进行文档分类：

- **常用标签**：灵修资料、圣经注释、神学书籍、事工手册、会议纪要
- **自定义标签**：管理员可创建新标签

### 上传文档

#### 管理员后台上传

1. 登录后台管理
2. 进入「文档管理」
3. 点击「上传文档」
4. 拖拽文件或点击选择
5. 填写文档信息
6. 点击「保存」


### 文档预览

系统支持在线预览：

- **PDF 文件**：使用 PDF.js 在线预览
- **图片文件**：直接显示
- **Office 文档**：下载后查看

### 文档下载

1. 进入「资料」页面
2. 找到目标文档
3. 点击文档卡片
4. 点击「下载」按钮

### 权限控制

文档可设置可见角色，只有指定角色的用户才能看到和下载。

**示例：**

- 神学书籍：仅 `admin` 和 `ministry` 可见
- 新人手册：所有角色可见
- 会议纪要：仅 `admin` 可见

---

## 颂主圣诗

提供圣诗歌曲库，方便成员学习和敬拜。

### 歌曲库

系统内置两个版本：

- **349 首版本**（默认）：经典版本
- **870 首版本**：完整版本


### 功能特性

#### 浏览歌曲

1. 进入「颂主圣诗」页面
2. 浏览歌曲列表
3. 点击歌曲名称进入详情页

#### 歌词查看

- 支持多页歌词图片
- 左右滑动翻页
- 双指缩放查看细节
- 微信图片预览集成

#### 音频播放

- HTML5 音频播放器
- 支持播放/暂停、快进/快退
- 显示播放进度和时长
- 后台播放（部分浏览器支持）

#### 搜索歌曲

- 按歌曲编号搜索
- 按歌曲名称搜索
- 按歌词内容搜索（如果启用全文搜索）


**迁移到本地存储：**

1. 下载所有资源文件
2. 上传到 Cloudflare R2 或本地 `public/songs/` 目录
3. 修改 `config/songs349.php` 中的 `base_url`：

```php
'base_url' => env('APP_URL') . '/songs',
```

---

## 后台管理

完整的后台管理系统，提供用户管理、内容管理、统计分析等功能。

### 登录后台

访问 `https://your-domain.com/admin/login`：

1. 输入管理员账号和密码
2. 点击「登录」

**默认管理员账号：**

运行 `php artisan db:seed` 后会自动创建：

- 用户名：`admin`
- 密码：`admin123456`
- 邮箱：`admin@example.com`

⚠️ **首次登录后请立即修改密码！**

### 仪表盘

**数据概览：**

- 用户总数
- 今日打卡人数
- 消息发送数量

**快捷操作：**

- 创建直播
- 发布学习任务
- 上传文档

### 用户管理

#### 查看用户列表

进入「用户管理」查看所有微信用户：

- 用户昵称、头像
- 员工工号、真实姓名
- 所属部门、职位
- 用户角色
- 状态（启用/禁用）
- 最后登录时间

#### 编辑用户

1. 找到目标用户
2. 点击「编辑」
3. 修改用户信息：
   - 员工工号
   - 真实姓名
   - 部门
   - 职位
   - 角色
   - 状态
4. 点击「保存」

#### 禁用/启用用户

1. 找到目标用户
2. 点击「禁用」或「启用」
3. 确认操作

被禁用的用户无法登录微信端。

### 管理员管理（超级管理员）

#### 创建管理员

1. 进入「管理员管理」
2. 点击「添加管理员」
3. 填写信息：
   - 用户名
   - 邮箱
   - 密码
4. 勾选权限
5. 点击「创建」

#### 权限分配

系统支持细粒度的权限分配，可以为每个管理员单独配置权限。

### 角色权限管理（超级管理员）

#### 编辑微信端角色权限

1. 进入「角色权限管理」
2. 选择「微信端权限」标签
3. 选择角色
4. 勾选/取消权限
5. 点击「保存」

#### 编辑后台管理端角色权限

1. 选择「后台管理权限」标签
2. 选择角色
3. 配置权限
4. 保存更改

### 直播管理

#### 查看直播列表

查看所有直播


### 文档管理

#### 文档列表

查看所有上传的文档：

- 文档标题、描述
- 上传者
- 文件大小
- 上传时间

#### 编辑文档

1. 找到目标文档
2. 点击「编辑」
3. 修改文档信息
4. 保存更改

#### 删除文档

1. 找到目标文档
2. 点击「删除」
3. 确认操作

文档删除后，文件也会从存储中删除。

### 学习任务管理

#### 查看任务列表

查看所有学习任务，支持按日期筛选。

#### 编辑任务

1. 找到目标任务
2. 点击「编辑」
3. 修改任务内容
4. 保存更改

#### 删除任务

1. 找到目标任务
2. 点击「删除」
3. 确认操作

### 打卡管理

#### 查看打卡统计

- 整体打卡率
- 各角色打卡情况
- 成员打卡排行


### 消息统计

查看聊天数据统计（仅统计数据，无法查看内容）：

- 消息总数
- 今日消息数
- 活跃用户数
- 群组数量


---

## 下一步

了解功能后，请参考以下文档深入使用：
- [端到端加密原理](CHAT_ENCRYPTION_README.md) - 加密机制
- [直播功能集成](REALTIMEKIT_INTEGRATION.md) - 直播技术详解

---